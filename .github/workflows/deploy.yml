name: Deploy to VPS

on:
    push:
        branches:
            - main

jobs:
    deploy:
        runs-on: ubuntu-latest

        steps:
            - name: Deploy via SSH
              uses: appleboy/ssh-action@v1.0.0
              with:
                  host: ${{ secrets.HOST }}
                  username: ${{ secrets.USER }}
                  key: ${{ secrets.SSH_KEY }}
                  script: |
                      if [ ! -d /opt/laravel-app/.git ]; then
                        git clone https://github.com/wardanaricho/laravel-docker-test.git /opt/laravel-app
                      fi

                      cd /opt/laravel-app
                      git pull origin main

                      docker rm -f laravel-app || true
                      docker rm -f mysql-db || true
                      docker rm -f nginx-web || true
                      docker compose down --remove-orphans

                      docker compose down --remove-orphans --volumes

                      docker compose up -d --build

                      docker exec laravel-app php artisan migrate --force
                      docker exec laravel-app php artisan config:cache
