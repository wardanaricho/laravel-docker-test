name: Deploy to VPS

on:
    push:
        branches:
            - main

jobs:
    deploy:
        runs-on: ubuntu-latest

        steps:
            - name: Deploy via SSH
              uses: appleboy/ssh-action@v1.0.0
              with:
                  host: ${{ secrets.HOST }}
                  username: ${{ secrets.USER }}
                  key: ${{ secrets.SSH_KEY }}
                  script: |
                      echo "ğŸ” Cloning repository if not exists"
                      if [ ! -d /opt/laravel-app/.git ]; then
                        git clone https://github.com/wardanaricho/laravel-docker-test.git /opt/laravel-app
                      fi

                      cd /opt/laravel-app

                      echo "ğŸ“¥ Pull latest code"
                      git pull origin main

                      echo "ğŸ§¹ Clean up old containers"
                      docker rm -f laravel-app || true
                      docker rm -f mysql-db || true
                      docker rm -f nginx-web || true

                      echo "ğŸ§¼ Docker Compose down + clean volumes"
                      docker compose down --remove-orphans --volumes

                      echo "ğŸ”¨ Rebuild and start containers"
                      docker compose up -d --build

                      echo "ğŸ“‹ Copying .env"
                      docker exec laravel-app cp .env.example .env

                      echo "ğŸ“¦ Installing Laravel dependencies"
                      docker exec laravel-app composer install --no-interaction --prefer-dist --optimize-autoloader

                      echo "âš™ï¸ Running Laravel post-deploy commands"
                      docker exec laravel-app php artisan key:generate
                      docker exec laravel-app php artisan migrate --fresh
                      docker exec laravel-app php artisan config:cache

                      echo "âœ… Deployment done!"
